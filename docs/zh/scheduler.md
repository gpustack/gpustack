# 调度器

## 概述

调度器的主要职责是计算模型实例所需的资源，并通过一系列策略评估并为模型实例选择最优的工作节点/GPU。这确保模型实例可以高效运行。本文详细介绍调度器所使用的策略与流程。

## 调度流程

### 过滤阶段

过滤阶段旨在将可用的工作节点或 GPU 缩小到满足特定条件的集合。主要涉及以下策略：

- 标签匹配策略
- 状态策略
- 资源匹配策略

#### 标签匹配策略

根据为模型配置的标签选择器过滤工作节点。如果模型未定义标签选择器，则视为所有工作节点都可用。否则，系统会检查每个工作节点的标签是否与模型的标签选择器匹配，仅保留匹配的工作节点。

#### 状态策略

根据工作节点的状态进行过滤，只保留处于 READY 状态的节点。

#### 资源匹配策略

资源匹配策略是调度系统中的关键策略，用于根据资源兼容性筛选工作节点或 GPU。该策略的目标是确保模型实例在所选节点上运行时不会超出资源限制。资源匹配策略按照以下优先级排序候选项：

- 单工作节点、单 GPU 完全卸载：识别在单个工作节点的一块 GPU 上即可将模型完全卸载的候选项，通常可获得最佳性能。
- 单工作节点、多 GPU 完全卸载：识别在单个工作节点上的多块 GPU 可以将模型完全卸载的候选项。
- 跨多个工作节点的分布式推理：识别由多个工作节点上的 GPU 组合可进行完全或部分卸载的候选项，仅在允许跨节点进行分布式推理时使用。
- 单工作节点部分卸载：识别在单个工作节点上可进行部分卸载的候选项，仅在允许部分卸载时使用。
- 单工作节点，CPU：当没有可用 GPU 时，系统将使用 CPU 进行推理，识别在单个工作节点上内存资源足以支撑的候选项。

### 评分阶段

评分阶段对过滤后的候选项进行评估打分，以选择最佳的部署位置。主要涉及的策略是：

- 放置策略

#### 放置策略

- Binpack

  该策略旨在将尽可能多的模型实例“打包”到尽可能少的“箱”（例如，工作节点/GPU）中，以优化资源利用率。目标是在不超过容量的前提下，最小化所使用的箱的数量并最大化资源效率。模型实例将被放置到剩余空间最少的箱中，从而尽量减少每个箱的剩余容量。

- Spread

  该策略力求将多个模型实例尽可能均匀地分布到不同的工作节点上，以提升系统的容错性和负载均衡能力。